name: Render Data Visualization Videos

on:
  push:
    paths:
      - 'data/render_queue/*.json'
  workflow_dispatch:

jobs:
  render-batch:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: Install Python dependencies
        run: |
          pip install matplotlib numpy pandas gtts
      
      - name: Create output directories
        run: |
          mkdir -p outputs
          mkdir -p data/completed
      
      - name: Render videos with voiceover
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import os
          import glob
          import matplotlib.pyplot as plt
          import matplotlib.animation as animation
          import numpy as np
          from datetime import datetime
          from gtts import gTTS
          import subprocess

          def generate_voiceover(text, output_file):
              """Generate voiceover using gTTS"""
              try:
                  tts = gTTS(text=text, lang='en', slow=False)
                  tts.save(output_file)
                  print(f"ðŸŽ¤ Voiceover created: {output_file}")
                  return True
              except Exception as e:
                  print(f"Error generating voiceover: {e}")
                  return False

          def render_video(config_file):
              """Render a comparison-style video with voiceover"""
              
              with open(config_file, 'r') as f:
                  config = json.load(f)
              
              video_id = config['id']
              print(f"ðŸ“¹ Rendering: {config['title']}")
              
              # Step 1: Generate voiceover
              audio_file = f"outputs/audio_{video_id}.mp3"
              voiceover_script = config.get('voiceover_script', 'No script available')
              
              if not generate_voiceover(voiceover_script, audio_file):
                  print("Warning: Voiceover generation failed, creating silent video")
                  audio_file = None
              
              # Get audio duration
              audio_duration = 3.0
              if audio_file and os.path.exists(audio_file):
                  result = subprocess.run(
                      ['ffprobe', '-v', 'error', '-show_entries', 
                       'format=duration', '-of', 'default=noprint_wrappers=1:nokey=1', 
                       audio_file],
                      capture_output=True,
                      text=True
                  )
                  try:
                      audio_duration = float(result.stdout.strip())
                      print(f"Audio duration: {audio_duration:.2f}s")
                  except:
                      audio_duration = 3.0
              
              # Step 2: Create video
              fig = plt.figure(figsize=(9, 16), dpi=120)
              fig.patch.set_facecolor('#000000')
              
              # Get data
              yesterday = config['data']['yesterday']
              today = config['data']['today']
              change_percent = config['data']['change_percent']
              
              # Colors
              is_positive = change_percent > 0
              main_color = '#00FF88' if is_positive else '#FF4444'
              arrow = 'â†‘' if is_positive else 'â†“'
              
              # Calculate frames
              fps = 30
              frames = int(audio_duration * fps)
              
              def animate(frame):
                  plt.clf()
                  fig.patch.set_facecolor('#000000')
                  
                  progress = frame / frames
                  
                  # Title
                  title_alpha = min(1.0, progress * 3)
                  plt.text(0.5, 0.85, config['title'], 
                           ha='center', fontsize=32, color='white',
                           weight='bold', alpha=title_alpha, 
                           transform=fig.transFigure)
                  
                  # YESTERDAY
                  if progress > 0.15:
                      yesterday_alpha = min(1.0, (progress - 0.15) * 4)
                      plt.text(0.5, 0.70, 'YESTERDAY', 
                               ha='center', fontsize=18, color='#888888',
                               alpha=yesterday_alpha, transform=fig.transFigure)
                      plt.text(0.5, 0.62, f'${yesterday:,.2f}', 
                               ha='center', fontsize=42, color='#CCCCCC',
                               weight='bold', alpha=yesterday_alpha, 
                               transform=fig.transFigure)
                  
                  # Arrow
